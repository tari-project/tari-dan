<html>
  <head>
    <style>
      .container {
        display: grid;
        grid-template-columns: auto auto;
        grid-template-rows: auto;
        justify-content: start;
        column-gap: 10px;
        grid-row-gap: 10px;
      }
      .singe-container {
        display: grid;
        grid-template-columns: auto;
        grid-template-rows: auto;
        justify-content: start;
        column-gap: 10px;
      }
      .key {
        font-family: monospace;
        font-size: large;
        user-select: all;
      }
      .item2 {
        grid-column-start: 1;
        grid-column-end: span 2;
      }
      .button {
        box-sizing: border-box;
        display: inline-block;
        margin: auto;
        margin-bottom: 5px;
        padding: 6px 14px;
        border: 1px solid black;
        border-radius: 6px;
        background-origin: border-box;
        box-shadow: 3px 3px 2px grey;
        user-select: none;
      }
      .button:hover {
        box-shadow: 5px 5px 2px grey;
      }
      .button:active {
        box-shadow: 1px 1px 2px grey;
      }
    </style>
    <script>
      var id = 0;
      function toHexString(byteArray) {
        return Array.from(byteArray, function (byte) {
          return ("0" + byte.toString(16)).slice(-2);
        }).join("");
      }
      async function json_rpc(method, params = NaN) {
        id += 1;
        let response = await fetch("http://{{address}}", {
          method: "POST",
          body: JSON.stringify({
            method: method,
            jsonrpc: "2.0",
            id: id,
            params: params,
          }),
          headers: {
            "Content-Type": "application/json",
          },
        });
        let json = await response.json();
        return json.result;
      }
      async function get_identity() {
        return await json_rpc("get_identity");
      }
      async function get_epoch_manager_stats() {
        return await json_rpc("get_epoch_manager_stats");
      }
      async function get_comms_stats() {
        return await json_rpc("get_comms_stats");
      }
      async function get_mempool_stats() {
        return await json_rpc("get_mempool_stats");
      }
      async function get_shard_key(height, public_key) {
        return await json_rpc("get_shard_key", [height, public_key]);
      }
      async function get_committee(height, shard_key) {
        return await json_rpc("get_committee", [height, shard_key]);
      }
      async function get_all_vns(epoch) {
        return await json_rpc("get_all_vns", epoch);
      }

      function compare(a, b) {
        if (a < b) return -1;
        if (a > b) return 1;
        return 0;
      }

      const zip = (a, b) => a.map((e, i) => [(e, b[i])]);

      function get_range(begin, end) {
        begin = [1, 2, 3];
        end = [2, 4, 6];
        return zip(begin, end);
      }

      class BigInt {
        constructor(number) {
          this.number = number;
        }
        minus(other) {
          let l = Math.max(this.number.length, other.number.length);
          let c = 0;
          let s = "";
          for (let i = 0; i < l; ++i) {
            let t = this.number?.[this.number.length - 1 - i] || "0";
            let o = other.number?.[other.number.length - 1 - i] || "0";
            let r;
            r = parseInt(t, 16) - (parseInt(o, 16) + c);
            if (r < 0) {
              c = 1;
              r += 16;
            } else {
              c = 0;
            }
            s = r.toString(16) + s;
          }
          return new BigInt(s);
        }
        compare(other) {
          let l = Math.max(this.number.length, other.number.length);
          for (let i = l - 1; i >= 0; --i) {
            let t = this.number?.[this.number.length - 1 - i] || "0";
            let o = other.number?.[other.number.length - 1 - i] || "0";
            if (t > o) return 1;
            if (t < o) return -1;
          }
          return 0;
        }
        gt = (other) => this.compare(other) == 1;
        ge = (other) => this.compare(other) >= 0;
        lt = (other) => this.compare(other) == -1;
        le = (other) => this.compare(other) <= 0;
        eq = (other) => this.compare(other) == 0;
      }

      // This function returns correct order of the shard keys. It also finds out if the range is on the edge.
      // Sorts the shard keys. And check the ranges in between and also from last to first. The largest range
      // is where the split is.
      // E.g. if the cycle was from 0 to 255, and the keys where 2, 5, 7, 200, 220, 240. The largest range is
      // not from the end to first (that's 18) but between 7 and 200. So this committee is over the edge.
      function reorder(committee) {
        committee.sort(compare);
        last_member = committee[committee.length - 1];
        last_member = new BigInt(last_member);
        largest_range = new BigInt("0");
        let split = 0;
        for (index in committee) {
          member = new BigInt(committee[index]);
          range = member.minus(last_member);
          if (largest_range.lt(range)) {
            split = index;
            largest_range = range;
          }
          last_member = member;
        }
        return committee.slice(split).concat(committee.slice(0, split));
      }

      function buttonClick(id) {
        let hidden = document.getElementById(`${id}-members`).style.display == "none";
        if (hidden) {
          document.getElementById(`${id}-members`).style.display = "";
          document.getElementById(`${id}-button`).innerHTML = "hide members";
        } else {
          document.getElementById(`${id}-members`).style.display = "none";
          document.getElementById(`${id}-button`).innerHTML = "show members";
        }
      }

      // Render shard space for this committee.
      function renderCommittee(committee) {
        committee_html = "";
        found = false;
        shards = [];
        for (member of committee.committee.members) {
          shards.push(shard_map[member]);
        }
        shards = reorder(shards);
        let begin = shards[(shards.length - 1) >> 1];
        let end = new BigInt(shards[(shards.length + 1) >> 1]);
        let one = new BigInt("1");
        // The end is excluded so we move it by one.
        end = end.minus(one).number;
        committee_html += `<div class="item button" id="${begin}-button" onClick='buttonClick("${begin}")'>show members</div>`;
        committee_html += '<div class="item"><pre>';
        if (begin > end) {
          committee_html += `┈───────────────────────┤ <span class='key'>${end}</span>                                                  <span class='key'>${begin}</span> ├───────────────────────┈`;
        } else {
          committee_html += `                          <span class='key'>${begin}</span> ├──────────────────────────────────────────────┤ <span class='key'>${end}</span>                        `;
        }
        committee_html += "</pre></div>";
        committee.committee.members.sort(compare);
        committee_html += `<div class="container item2" id='${begin}-members' style="display:none">`;
        for (member of committee.committee.members) {
          if (member == identity.public_key) {
            found = true;
            committee_html += `<div class="item">Public key</div><div class="item key"><b>${member}</b></div>`;
          } else {
            committee_html += `<div class="item">Public key</div><div class="item key">${member}</div>`;
          }
        }
        committee_html += "</div>";
        return found;
      }

      function renderCommittees(committees) {
        committees_html = '<div class="container">';
        for (committee of committees) {
          if (renderCommittee(committee)) {
            committees_html += committee_html;
            // committees_html += '<div class="item"><hr/></div>';
          }
        }
        committees_html += "</div>";
        committees_html += "<hr/>";
        document.getElementById("committees").innerHTML = committees_html;
      }

      onload = async function () {
        identity = await get_identity();
        epoch_manager_stats = await get_epoch_manager_stats();
        comms_stats = await get_comms_stats();
        mempool_stats = await get_mempool_stats();
        height = 60;
        shard_key = await get_shard_key(height, identity.public_key);
        committee = await get_committee(epoch_manager_stats.current_epoch, shard_key.shard_key);
        committee?.committee?.members?.sort(compare);
        shard_map = {};
        committees = [];
        if (Array.isArray(committee?.committee?.member)) {
          committees.push(committee);
        }
        shards = [];
        if (Array.isArray(committee?.committee?.member)) {
          for (member of committee?.committee?.members) {
            member_shard_key = await get_shard_key(height, member);
            shards.push(member_shard_key.shard_key);
            shard_map[member] = member_shard_key.shard_key;
            if (member_shard_key.shard_key !== shard_key.shard_key) {
              committees.push(await get_committee(epoch_manager_stats.current_epoch, member_shard_key.shard_key));
            }
          }
        }
        shards = reorder(shards);
        // TODO: This solves evenly sized committee that "leans" to the left.
        // E.g. if we have committee of size 4 and we have shard keys 1,2,3,4,5,6
        // Then if this VN has shard key 3, then get_committe(3) = [1,2,3,4]. So I add
        // committees for other keys get_committe([1,2,4]). But we are not part of get_committee(1)=[4,6,1,2], but we are
        // part of get_committee(5)=[3,4,5,6]

        for (committee of committees) {
          for (member of committee.committee.members) {
            if (!(member in shard_map)) {
              shard_map[member] = (await get_shard_key(height, member)).shard_key;
            }
          }
        }
        vns = await get_all_vns(epoch_manager_stats.current_epoch);
        document.getElementById("public-key").innerHTML = identity.public_key;
        document.getElementById("public-address").innerHTML = identity.public_address;
        document.getElementById("node-id").innerHTML = toHexString(identity.node_id);
        document.getElementById("current-epoch").innerHTML = epoch_manager_stats.current_epoch;
        document.getElementById("is-valid").innerHTML = epoch_manager_stats.is_valid;
        document.getElementById("comms-stats").innerHTML = comms_stats.connection_status;
        document.getElementById("mempool-stats").innerHTML = mempool_stats.size;
        document.getElementById("shard-key").innerHTML = shard_key.shard_key;
        renderCommittees(committees);
        vns_html = '<div class="container">';
        vns.vns.sort((a, b) => compare(a.shard_key, b.shard_key));
        for (vn of vns.vns) {
          vns_html += `<div class="item">Public key</div><div class="item key">${vn.public_key}</div>`;
          vns_html += `<div class="item">Shard key</div><div class="item key">${vn.shard_key}</div>`;
          vns_html += '<div class="item"><hr/></div>';
          vns_html += '<div class="item"><hr/></div>';
        }
        vns_html += "</div>";
        document.getElementById("all-vns").innerHTML = vns_html;
      };
    </script>
  </head>
  <body>
    <div class="container">
      <div class="item">Public key</div>
      <div class="item key" id="public-key"></div>
      <div class="item">Public address</div>
      <div class="item key" id="public-address"></div>
      <div class="item">Node Id</div>
      <div class="item key" id="node-id"></div>
      <div class="item">Shard key</div>
      <div class="item key" id="shard-key"></div>
      <div class="item">Current epoch</div>
      <div class="item" id="current-epoch"></div>
      <div class="item">Current epoch is valid</div>
      <div class="item" id="is-valid"></div>
      <div class="item">Comms stats</div>
      <div class="item" id="comms-stats"></div>
      <div class="item">Mempool stats</div>
      <div class="item" id="mempool-stats"></div>
      <div class="item">Committees</div>
      <div class="item" id="committees"></div>
      <div class="item">VNs</div>
      <div class="item" id="all-vns"></div>
    </div>
  </body>
</html>
